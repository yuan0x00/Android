name: Build and Release

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬åç§° (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      is_prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Version Name
        run: |
          VERSION="${{ github.event.inputs.version_name || github.ref_name }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION. Use vX.Y.Z" >&2
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Verify Signing Assets
        run: |
          if [ ! -f app/release.jks ]; then
            echo "âŒ ç­¾åæ–‡ä»¶ app/release.jks ç¼ºå¤±" >&2
            exit 1
          fi
          if [ ! -f keystore.properties ]; then
            echo "âŒ ç­¾åé…ç½® keystore.properties ç¼ºå¤±" >&2
            exit 1
          fi
          echo "âœ… ç­¾åæ–‡ä»¶æ£€æµ‹å®Œæˆ"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build Release APK with Cache
        run: ./gradlew assembleRelease --build-cache

      - name: Find APK File
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f | grep release | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK file not found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Found APK: $APK_PATH"

      - name: Generate Release Notes
        id: release-notes
        run: |
          VERSION="${{ github.event.inputs.version_name || github.ref_name }}"
          
          # æ‰¾ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 "$VERSION^" 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found. Showing all commits."
            git log --pretty=format:"- %s (%h)" > commits.md
          else
            git log "$LAST_TAG..HEAD" --pretty=format:"- %s (%h)" > commits.md
          fi

          # ç”Ÿæˆå®Œæ•´ release notes
#          echo "## Release $VERSION" > release_notes.md
#          echo "" >> release_notes.md
#          echo "### æ„å»ºä¿¡æ¯" >> release_notes.md
#          echo "- æ„å»ºæ—¶é—´: $(date)" >> release_notes.md
#          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> release_notes.md
#          echo "" >> release_notes.md
#          echo "### å˜æ›´æ—¥å¿—" >> release_notes.md
#          cat commits.md >> release_notes.md
#          echo "âœ… Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version_name || github.ref_name }}
          name: Release ${{ github.event.inputs.version_name || github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}
          files: ${{ steps.find-apk.outputs.APK_PATH }}

      - name: Notify Success
        if: success()
        run: |
          echo "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆ!"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version_name || github.ref_name }}"