name: Build and Release

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'
  workflow_dispatch:
    inputs:
      version_name:
        description: '版本名称 (例如: v1.0.0)'
        required: true
        default: 'v1.0.0'
      is_prerelease:
        description: '是否为预发布版本'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Signing Assets
        run: |
          if [ ! -f app/release.jks ]; then
            echo "❌ 签名文件 app/release.jks 缺失" >&2
            exit 1
          fi
          if [ ! -f keystore.properties ]; then
            echo "❌ 签名配置 keystore.properties 缺失" >&2
            exit 1
          fi
          echo "✅ 签名文件检测完成"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Find APK File
        id: find-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" -type f | grep release | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "❌ APK file not found!"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "✅ Found APK: $APK_PATH"

      - name: Generate Release Notes
        id: release-notes
        run: |
          VERSION="${{ github.event.inputs.version_name || github.ref_name }}"
          echo "## Release $VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "### 构建信息" >> release_notes.md
          echo "- 构建时间: $(date)" >> release_notes.md
          echo "- 触发方式: ${{ github.event_name }}" >> release_notes.md
          echo "- Commit: ${{ github.sha }}" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version_name || github.ref_name }}
          name: Release ${{ github.event.inputs.version_name || github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}
          files: ${{ steps.find-apk.outputs.APK_PATH }}

      - name: Notify Success
        if: success()
        run: |
          echo "🎉 构建和发布完成!"
          echo "版本: ${{ github.event.inputs.version_name || github.ref_name }}"